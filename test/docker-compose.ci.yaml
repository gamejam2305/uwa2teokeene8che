# Docker Compose configuration for CI environments
# Uses more lenient settings for unstable test environments

services:
  passenger_with_app:
    build:
      context: ../
      dockerfile: test/dockerfiles/Dockerfile.with-app
    hostname: 'passenger_with_app'
    ports:
      - "10254"
    networks:
      - test_network
      
  passenger_without_app:
    build:
      context: ../
      dockerfile: test/dockerfiles/Dockerfile.without-app
    hostname: 'passenger_without_app'
    ports:
      - "10254"
    networks:
      - test_network
      
  passenger_with_visible_prometheus:
    build:
      context: ../
      dockerfile: test/dockerfiles/Dockerfile.with-visible-prometheus-app
    hostname: 'passenger_with_visible_prometheus'
    ports:
      - "10254"
    networks:
      - test_network
      
  test:
    image: "phusion/passenger-ruby32:2.5.1"
    command: ["/src/test/run_all_tests_ci.sh"]
    volumes:
      - ../:/src
    networks:
      - test_network
    working_dir: /src
    
networks:
  test_network:
    driver: bridge
