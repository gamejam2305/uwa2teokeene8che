# JRuby-based Passenger container with dummy application
FROM phusion/passenger-jruby94:2.5.1

ENV PASSENGER_DISABLE_SECURITY_UPDATE_CHECK=true \
    HOME=/app \
    JRUBY_OPTS="--server -Xcompile.invokedynamic=true" \
    JAVA_OPTS="-Xmx1G -Xms256M -XX:+UseG1GC"

WORKDIR /app

# Install required packages including curl for health checks
RUN apt-get update && apt-get install -y curl && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install dumb-init
RUN curl -s -L -o /usr/local/bin/dumb-init https://github.com/Yelp/dumb-init/releases/download/v1.2.5/dumb-init_1.2.5_$(uname -m) \
    && chmod +x /usr/local/bin/dumb-init

ENTRYPOINT ["/usr/local/bin/dumb-init"]
CMD ["passenger", "start", "--port", "80", "--log-file=/dev/stdout", "--nginx-config-template", "/nginx.conf.erb"]

# Install bundler and configure for JRuby
RUN gem install bundler:2.4.22 \
    && bundle config --global silence_root_warning 1

# Install monitor app dependencies (JRuby version)
COPY src/Gemfile.jruby /monitor/Gemfile
RUN cd /monitor && bundle install --jobs=4 --retry=3

# Install dummy app dependencies
COPY test/dummy-app/Gemfile /app/Gemfile
RUN cd /app && bundle install --jobs=4 --retry=3

# Copy configuration and applications
COPY test/nginx-configurations/nginx.conf.erb /nginx.conf.erb
COPY test/dummy-app/ /app/

# Copy source with JRuby-optimized config
COPY src/ /monitor/
COPY src/config.ru.jruby /monitor/config.ru

# Health check - use port 80 and wait longer for JRuby startup
HEALTHCHECK --interval=30s --timeout=15s --start-period=60s --retries=5 \
  CMD curl -f http://localhost:80/monitus/metrics || exit 1
