# Supervisor конфигурация для JRuby + Nginx

# JRuby + Puma процесс
[program:jruby-puma]
command=/usr/local/bin/jbundle exec puma -C config/puma.rb simple-config.ru
directory=/home/app/webapp
user=app
environment=RACK_ENV="production",JRUBY_OPTS="-Xcompile.invokedynamic=true -J-Djnr.ffi.asm.enabled=false",JAVA_OPTS="-Xmx1G -Xms256M -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Djnr.netdb.provider=files",BUNDLE_PATH="/home/app/webapp/vendor/bundle",BUNDLE_WITHOUT="development:test"
stdout_logfile=/var/log/webapp/jruby.log
stderr_logfile=/var/log/webapp/jruby.error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_backups=3
autorestart=true
startretries=3
startsecs=10
stopsignal=TERM
stopwaitsecs=30
killasgroup=true
stopasgroup=true
priority=10

# Nginx процесс
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx.error.log
autorestart=true
startretries=3
startsecs=5
stopsignal=QUIT
stopwaitsecs=10
priority=20

# Group configuration
[group:jruby-services]
programs=jruby-puma,nginx