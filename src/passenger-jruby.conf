# Passenger configuration for JRuby optimization

# Global Passenger settings
passenger_root /usr/lib/ruby/vendor_ruby/phusion_passenger/locations.ini;

# JRuby-specific settings
passenger_ruby /usr/local/bin/jruby;
passenger_default_ruby /usr/local/bin/jruby;

# Performance tuning for JRuby
# JRuby benefits from longer startup time but better thread performance
passenger_spawn_method smart;
passenger_pool_idle_time 300;
passenger_max_pool_size 8;
passenger_min_instances 2;

# JRuby startup optimization
passenger_pre_start http://localhost:80/health;
passenger_startup_file config.ru;

# Memory and CPU limits
passenger_memory_limit 1024;
passenger_max_instances_per_app 8;

# Request handling
passenger_max_request_queue_size 100;
passenger_request_queue_overflow_status_code 503;

# Threading model (optimal for JRuby)
passenger_concurrency_model thread;
passenger_thread_count 16;

# Logging and monitoring
passenger_log_level 1;
passenger_disable_log_prefix off;
passenger_show_version_in_header off;

# Security
passenger_friendly_error_pages off;
passenger_disable_security_update_check on;

# JRuby environment variables
passenger_env_var JRUBY_OPTS '-Xcompile.invokedynamic=true -J-Djnr.ffi.asm.enabled=false';
passenger_env_var JAVA_OPTS '-Xmx1G -Xms256M -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Djnr.netdb.provider=files';
passenger_env_var RACK_ENV production;
passenger_env_var PASSENGER_APP_ENV production;

# JRuby-specific timeouts (JRuby may need longer startup time)
passenger_startup_timeout 180;
passenger_response_buffer_high_watermark 2097152;